<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --samu-dark:#b71c1c;
  --samu-red:#e74c3c;
  --samu-yellow:#f1c40f;
  --samu-green:#2ecc71;
  --blue:#2980b9;
  --card:#fff;
  --bg:#f4f4f4;
  --muted:#777;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:var(--bg);color:#222}
header{display:flex;align-items:center;background:var(--samu-dark);color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:12px;box-shadow:0 4px 8px rgba(0,0,0,0.08)}
.header-img{height:56px;margin-right:12px;border-radius:6px;flex:0 0 56px}
header h1{font-size:20px;margin:0;font-weight:700}
.controls-row{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.top-buttons{display:flex;gap:8px;flex-wrap:wrap}
button.top-btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
#btn-excluir{background:var(--samu-red);color:#fff}
#btn-exportar{background:var(--blue);color:#fff}
#btn-relatorio{background:#27ae60;color:#fff}
#btn-atualizar-enderecos{background:#f39c12;color:#fff}
#btn-add-endereco{background:#8e44ad;color:#fff}
.search-input{padding:8px;border-radius:6px;border:1px solid #ddd;width:280px}
#form-chamado{background:var(--card);padding:10px;border-radius:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06);margin-bottom:12px}
#form-chamado input,#form-chamado select,#form-chamado button{padding:8px;border-radius:6px;border:1px solid #d0d0d0}
#form-chamado button{background:var(--samu-red);color:#fff;border:none;cursor:pointer;grid-column:span 2}
.small-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer;margin-left:6px}
.add-opt-btn{background:#2d9cdb;color:#fff}
.table-card{background:var(--card);border-radius:8px;overflow:auto;box-shadow:0 3px 8px rgba(0,0,0,0.06);padding:0}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
th{background:var(--samu-dark);color:#fff;position:sticky;top:0}
tr:hover td{background:#fbfbfb}
.dup-btn{background:var(--blue);color:#fff;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
.sel-item{cursor:pointer}
.status{display:inline-block;padding:6px 8px;border-radius:6px;font-weight:600;font-size:12px}
.status[data-status="normal"]{background:var(--samu-green);color:#fff}
.status[data-status="urgencia"]{background:var(--samu-yellow);color:#000}
.status[data-status="emergencia"]{background:var(--samu-red);color:#fff}
.duplicado td{background:#3498db;color:#fff}
.alerta td{animation:pulse 1.2s infinite;border:2px solid orange}
@keyframes pulse{0%{background:#fef3cf}50%{background:#fde3b6}100%{background:#fef3cf}}
.edit-btn, .save-btn, .cancel-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer;margin-left:6px}
.edit-btn{background:#f39c12;color:#fff}
.save-btn{background:#2ecc71;color:#fff}
.cancel-btn{background:#95a5a6;color:#fff}
.chat-container{margin-top:10px}
.chat-input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;background:var(--samu-red);color:#fff}
#graficos{margin-top:12px;background:var(--card);padding:12px;border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,0.06)}
.section-title{margin:0 0 8px 0;font-size:15px}
.notice{font-size:13px;color:var(--muted);margin-bottom:10px}
@media (max-width:900px){header h1{font-size:16px} .search-input{width:100%} table{min-width:800px}}
</style>
</head>
<body>
<header>
  <!-- imagem principal (fallback SVG se o src falhar) -->
  <img id="logoImg" class="header-img" src="https://i.imgur.com/7Tx6bU1.png" alt="Ambul√¢ncia 192">
  <h1>Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</h1>
</header>

<div class="controls-row">
  <div class="top-buttons" role="toolbar" aria-label="A√ß√µes principais">
    <button id="btn-excluir" class="top-btn">üóëÔ∏è Excluir Selecionados</button>
    <button id="btn-exportar" class="top-btn">üì• Exportar CSV</button>
    <button id="btn-relatorio" class="top-btn">üìä Relat√≥rio Mensal</button>
    <button id="btn-atualizar-enderecos" class="top-btn">üîÑ Atualizar Endere√ßos</button>
    <button id="btn-add-endereco" class="top-btn">‚ûï Acrescentar Endere√ßo</button>
  </div>

  <input id="search" class="search-input" placeholder="Buscar paciente, motorista, destino..." />
</div>

<div class="notice">Observa√ß√£o: o sistema tenta carregar seu CSV publicado. Se o navegador bloquear (CORS), os dados ser√£o carregados do backup local. Para sincronizar com Google Sheets sem CORS use um Apps Script Web App (vejo coment√°rio no script).</div>

<form id="form-chamado" onsubmit="return false;">
  <input id="nome" placeholder="Nome do paciente" type="text" required>
  <input id="telefone" placeholder="Telefone" type="text">
  <div style="display:flex;gap:6px;align-items:center">
    <select id="endereco" aria-label="Endere√ßo" style="flex:1"></select>
    <button id="btn-add-endereco-manual" type="button" class="small-btn add-opt-btn">‚ûï</button>
  </div>

  <input id="numero" placeholder="N√∫mero" type="text">
  <div style="display:flex;gap:6px;align-items:center">
    <select id="chamado" aria-label="Tipo">
      <option value="normal">Normal</option>
      <option value="urgencia">Urg√™ncia</option>
      <option value="emergencia">Emerg√™ncia</option>
    </select>
  </div>

  <div style="display:flex;gap:6px;align-items:center">
    <select id="destino" aria-label="Destino" style="flex:1"></select>
    <button id="add-destino" type="button" class="small-btn add-opt-btn">‚ûï</button>
  </div>

  <div style="display:flex;gap:6px;align-items:center">
    <select id="prioridade" aria-label="Prioridade" style="flex:1"></select>
    <button id="add-prioridade" type="button" class="small-btn add-opt-btn">‚ûï</button>
  </div>

  <input id="atendente" placeholder="Atendente (seu nome)" type="text" required>
  <input id="motorista" placeholder="Motorista" type="text">
  <input id="observacoes" placeholder="Observa√ß√µes" type="text">
  <button id="adicionar" type="button">Adicionar Chamado</button>
</form>

<div class="table-card" aria-live="polite">
  <table id="tabela-chamados" aria-label="Tabela de chamados">
    <thead>
      <tr>
        <th><input id="sel-all" type="checkbox" aria-label="Selecionar todos"></th>
        <th>Data</th>
        <th>Hora</th>
        <th>Paciente</th>
        <th>Endere√ßo</th>
        <th>N√∫mero</th>
        <th>Telefone</th>
        <th>Chamado</th>
        <th>Destino</th>
        <th>Prioridade</th>
        <th>Atendente</th>
        <th>Motorista</th>
        <th>Observa√ß√µes</th>
        <th>‚§¥Ô∏è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="chat-container">
  <input class="chat-input" placeholder="Chat interno (mensagens n√£o s√£o persistidas aqui)" />
</div>

<div id="graficos">
  <h3 class="section-title">Gr√°fico Mensal de Chamados</h3>
  <canvas id="graficoMensal" height="140"></canvas>
</div>

<script>
/* --------------- CONFIG --------------- */
/* (Opcional) cole aqui URL do Apps Script Web App para POST (cira um endpoint sem CORS).
   Se voc√™ publicar um Apps Script que retorna CSV ou aceita POST, coloque a URL abaixo. */
const API_URL = ''; // ex: 'https://script.google.com/macros/s/AKfyc.../exec'

/* CSV p√∫blico (se dispon√≠vel). Se fetch falhar por CORS, usamos backup localStorage. */
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3_8QPyI7v109xYun_zxMKwqpoSmzPwbGaB4kvyHizG4IeJjR9ZGZHr1VF5WKsJWhcMFYnqeuosmrU/pub?output=csv";

/* ---------- Lista de endere√ßos (logradouros) de Guai√ßara-SP (extra√≠da do site indicado) ---------- */
/* Esta lista foi obtida das p√°ginas do site cep.guiamais.com.br/sp/guaicara/logradouros
   (v√°rias p√°ginas paginadas) e deduplicada. Se quiser acrescentar mais, use o bot√£o ‚ûï. */
const enderecoLista = [
"Via de Acesso Herm√≠nio Paizan","R Ot√°vio Maitan - Tavico","R Coronel-Pol√≠cia Militar Eduardo Assump√ß√£o",
"R Jos√© Gringo dos Santos","R Guerino Campaner","R Jos√© Ferreira Pessoa","R Joaquim Rodrigues",
"R Martiniano Cruz","R Aristides Bento","R Jovino Faustino Rosa","R Hiroshi Suzuki",
"R No√© Franco da Rocha","R Agenor Leme Franco","R Fausto Longo Baptista Pereira",
"R Hil√°rio Teixeira da Silva","R Jos√© de Souza","R Ana de Jesus Maia","R Angelin Garoze",
"Tv Mariano Martinez","Av Duque de Caxias","Av Nove de Julho","Via de Acesso Jos√© Martinez Rodrigues",
"R Ad√£o Afonso Costa","R Yoshi Sato","R Sunao Katsuki","R Rio Branco","R Frei Henrique",
"R Jos√© do Patroc√≠nio","R Tiradentes","R da Amizade","R Osvaldo Cruz","R Rui Barbosa",
"R Jose Bonif√°cio","R Marechal Deodoro","R Antonio Buzinaro","R Doutor Arnaldo de Andrade",
"R Pedro Dutra Sobrinho","Tv Vereador Pl√°cido Pereira de Magalh√£es","R Osvaldo Pereira",
"R Ercilio Lima dos Santos","R Orlando Jorge","R Dirce Camargo Vaz","R Jo√£o Pac√≠fico da Silva",
"R Airton Alves dos Santos","R Jos√© Francisco Moco","R Mario Pereira da Silva","R Antonio Monteiro Paschoal",
"R Manoel dos Reis Soares","R Luiz Caetano","R Luiz Esperan√ßa","R Ana Carlotta Arruda Paula",
"R Jayme Pereira de Oliveira","R Valdemir Bridi","R Jo√£o Batista do Amaral Caldas",
"R F√©lix Umbelino","R Dirceu Sanches","Av Henrique Bertin","R Sabino","R Sebasti√£o de Souza",
"Av Paulo Xavier Ribeiro","Tv √Ålvaro Bittencourt","R Jos√© Graciotin","R Ernesto Bianchini",
"R Luiz Buzinaro","R Soldado-Pol√≠cia Militar Carlos Trombini","R Joana Biscaro Pereira",
"R Bernardino Alves","R Antonio Cez√°rio","R Eliseo Nunes","R Nelson Costa","R Maria Purcina Dias",
"R Professora Adelaide Baptista Pereira Cruz","R Hor√°cio Ramos Nogueira","R Urbano Pierre",
"R Ofriner Paulo Palo","R Felicio Takase","R Helena Lucas Franco da Rocha",
"R Elza Katsuki Ishizaka","R C√¥nego Lino Braz Branwart","R Luiz Vieira","R Francisco Ramos dos Santos",
"R Mario Maitan","R Esmeraldo Cruz","R Joaquim Francisco de Paula","R Cabo-Pol√≠cia Militar Miguel Redondo",
"R Luis de Almeida Rosa","R Roman Garcia Echeto","R Antonio Br√°z Herrero","R Jonas Miranda",
"Alameda dos Manac√°s","Alameda das Ac√°cias","Alameda das Azal√©ias","Alameda dos L√≠rios",
"Alameda das Rosas","Alameda das Orqu√≠deas","Alameda das Hort√™ncias","Alameda das Violetas",
"Alameda dos Jasmins","Alameda dos Girass√≥is","R Cateto","R La√©rcio Domingos","R Luiz Cruz",
"R Domingos Antunes de Souza","R Jos√© Roberto Coutinho Junior","R Maestro Jo√£o Pavezzi",
"R Pedro Bertolino","R Vitor Maida","R Marcelo de Alencar Bento","R Job Dias de Oliveira",
"R Manoel Joaquim Cordeiro","R √âlcio Joaquim dos Santos","R Rog√™ Ferreira","R Maria Luiza Costa Raimundo",
"R Celso de Souza","R Julio Santini","R Jo√£o Gon√ßalves Rocha","R Jos√© Wilson Vicentino",
"R Felix Cardoso Gomes","R Vereador Nelson Evaristo Teixeira","R Paulo C√©sar Pereira",
"R Olivio Alves de Oliveira","R Soldado-Pol√≠cia Militar Gilberto Augustinho",
"R Augusto Rodrigues Profeta","R Mario Cardoso","R Pedro Pavoni","R Jo√£o Lopes",
"R Vereador Muneo Nakano","R Deloy do Ros√°rio de Jesus","R Jos√© Antonio de Souza",
"R Otacilio Pereira dos Santos","R Maria de Lourdes Pinto Jorge","R Gino Kenji Ishizaka",
"R Vice-Prefeito Paulo Katsuki","R Armando Gava","R Edson Vander Camacho","R Edwirges Gon√ßalves Thomas",
"R Jos√© Francisco da Costa","R Antonio Carlos de Oliveira","R dos Trabalhadores","R do Concenso",
"R dos Industri√°rios","R Arlindo Pita","R Euclides Bridi","R Jos√© Pereira",
"R Rosangela Aparecida dos Santos Oliveira","R Geraldo Tremeschin Silva","Av Antonio Rodolpho Cantoni",
"R Antonio Luiz Ferreira","R Izabel Fresneda Carmona","R Vereadora Ana Maria Herrera Fresca",
"R Milton Bittencourt","R Jos√© Pianta","R Afonso da Silva","R Amadeu Jorge",
"R Joaquim Benedito da Silva","R Wuillian Kfouri","R Alcides Osvaldo Pavoni",
"R Vereador Jo√£o Souto Pereira","R Vereador Celso Lousada Bittencourt","Av Andr√© de Souza Lima",
"R Aristides Cruz","R Luiz Teixeira Lima"
];
/* --------------------------------------- */

let chamados = []; // in-memory array of objects
const tbody = document.querySelector('#tabela-chamados tbody');

/* ---------- helpers ---------- */
function nowDateTime(){
  const n = new Date();
  const dd = String(n.getDate()).padStart(2,'0');
  const mm = String(n.getMonth()+1).padStart(2,'0');
  const yyyy = n.getFullYear();
  const hh = String(n.getHours()).padStart(2,'0');
  const min = String(n.getMinutes()).padStart(2,'0');
  return {date:`${dd}/${mm}/${yyyy}`, time:`${hh}:${min}`};
}

function getSelectOptions(id){
  return Array.from(document.getElementById(id).options).map(o=>o.value).filter(v=>v);
}

/* populate selects for endereco, prioridade, destino with saved options if any */
function populateEnderecoOptions(){
  const sel = document.getElementById('endereco');
  sel.innerHTML = '<option value="">Selecione o endere√ßo</option>';
  enderecoLista.forEach(e=>{
    const opt = document.createElement('option'); opt.value = e; opt.text = e; sel.appendChild(opt);
  });
}
function populatePrioridadeDestinoDefaults(){
  const prior = document.getElementById('prioridade');
  prior.innerHTML = '<option value="">Selecione a prioridade</option>';
  const priorDefault = ["Nenhuma","Curativo","Doen√ßas cr√¥nicas ou complica√ß√µes","Urg√™ncia","Emerg√™ncia","Normal","P√≥s-consulta"];
  priorDefault.forEach(p=> { const o=document.createElement('option'); o.value=p; o.text=p; prior.appendChild(o); });

  const dest = document.getElementById('destino');
  dest.innerHTML = '<option value="">Selecione o destino</option>';
  const destDefault = ["Hospital Municipal","UPA","CSIII"];
  destDefault.forEach(d=> { const o=document.createElement('option'); o.value=d; o.text=d; dest.appendChild(o); });
}

/* ---------- render tabela ---------- */
function renderTabela(filter=''){
  tbody.innerHTML = '';
  chamados.forEach((c, idx) => {
    const textSearch = (c.Paciente + c.Telefone + c.Endereco + c.Atendente + c.Destino + c.Observacoes).toLowerCase();
    if(filter && !textSearch.includes(filter.toLowerCase())) return;
    const tr = document.createElement('tr');
    tr.dataset.atendente = c.Atendente || '';
    tr.dataset.index = idx;
    // detect duplicated same patient same date
    const duplicadosHoje = chamados.filter(x=>x.Paciente===c.Paciente && x.Data===c.Data).length > 1;
    if(duplicadosHoje) tr.classList.add('duplicado');
    const totalMesmo = chamados.filter(x=>x.Data===c.Data).length;
    if(totalMesmo>3) tr.classList.add('alerta');

    const chamadoLabel = (c.Chamado||'').charAt(0).toUpperCase() + (c.Chamado||'').slice(1);
    tr.innerHTML = `
      <td><input type="checkbox" class="sel-item"></td>
      <td>${c.Data||''}</td>
      <td>${c.Hora||''}</td>
      <td>${c.Paciente||''}</td>
      <td>${c.Endereco||''}</td>
      <td>${c.Numero||''}</td>
      <td>${c.Telefone||''}</td>
      <td class="status" data-status="${(c.Chamado||'').toLowerCase()}">${chamadoLabel}</td>
      <td>${c.Destino||''}</td>
      <td>${c.Prioridade||''}</td>
      <td>${c.Atendente||''}</td>
      <td>${c.Motorista||''}</td>
      <td>${c.Observacoes||''}</td>
      <td>
        <button class="dup-btn" data-idx="${idx}">‚ûï</button>
        <button class="edit-btn" data-idx="${idx}">Editar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  attachRowEvents();
  atualizarGraficoMensal();
}

/* ---------- carregar CSV inicial (tenta fetch; pode falhar por CORS) ---------- */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim()!=='');
  if(lines.length===0) return [];
  const headers = lines[0].split(',').map(h=>h.replace(/(^"|"$)/g,'').trim());
  const rows = lines.slice(1);
  return rows.map(r=>{
    const cols = [];
    let cur='', inQ=false;
    for(let i=0;i<r.length;i++){
      const ch = r[i];
      if(ch === '"'){ if(inQ && r[i+1]==='"'){ cur+='"'; i++; } else { inQ = !inQ; } continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; continue; }
      cur += ch;
    }
    cols.push(cur);
    const obj = {};
    for(let i=0;i<headers.length;i++) obj[headers[i]] = (cols[i]||'').replace(/(^"|"$)/g,'').trim();
    return obj;
  });
}

async function carregarCSVinicial(){
  try{
    const res = await fetch(urlCSV);
    if(!res.ok) throw new Error('status '+res.status);
    const text = await res.text();
    const parsed = parseCSV(text);
    if(parsed.length>0){
      parsed.forEach(row=>{
        const item = {
          Data: row['Data'] || row['data'] || row['Date'] || '',
          Hora: row['Hora'] || row['hora'] || row['Time'] || '',
          Paciente: row['Paciente'] || row['Nome'] || row['nome'] || '',
          Endereco: row['Endere√ßo'] || row['Endereco'] || row['logradouro'] || '',
          Numero: row['N√∫mero'] || row['Numero'] || '',
          Telefone: row['Telefone'] || row['telefone'] || '',
          Chamado: row['Chamado'] || row['Tipo'] || row['tipo'] || '',
          Destino: row['Destino'] || row['destino'] || '',
          Prioridade: row['Prioridade'] || row['prioridade'] || '',
          Atendente: row['Atendente'] || row['atendente'] || '',
          Motorista: row['Motorista'] || row['motorista'] || '',
          Observacoes: row['Observa√ß√µes'] || row['Observacoes'] || row['Obs'] || ''
        };
        chamados.push(item);
      });
      saveLocal(); // backup
      renderTabela();
      return;
    }
  }catch(err){
    console.warn('N√£o foi poss√≠vel carregar CSV p√∫blico (CORS ou outro erro):', err);
    // fallback para localStorage
    loadLocal();
    renderTabela();
  }
}

/* ---------- adicionar chamado ---------- */
function adicionarChamado(){
  const nome = document.getElementById('nome').value.trim();
  const atendente = document.getElementById('atendente').value.trim();
  if(!nome || !atendente){ alert('Preencha pelo menos Nome do paciente e Atendente'); return; }
  const dt = nowDateTime();
  const obj = {
    Data: dt.date,
    Hora: dt.time,
    Paciente: nome,
    Endereco: document.getElementById('endereco').value.trim(),
    Numero: document.getElementById('numero').value.trim(),
    Telefone: document.getElementById('telefone').value.trim(),
    Chamado: document.getElementById('chamado').value,
    Destino: document.getElementById('destino').value.trim(),
    Prioridade: document.getElementById('prioridade').value,
    Atendente: atendente,
    Motorista: document.getElementById('motorista').value.trim(),
    Observacoes: document.getElementById('observacoes').value.trim()
  };
  chamados.push(obj);
  renderTabela(document.getElementById('search').value);
  saveLocal();
  if(API_URL) fetch(API_URL, {method:'POST', body: JSON.stringify(obj)}).catch(()=>{});
  // clear certain fields
  document.getElementById('nome').value='';
  document.getElementById('telefone').value='';
  document.getElementById('numero').value='';
  document.getElementById('observacoes').value='';
}

/* ---------- row events (dup/edit) ---------- */
function attachRowEvents(){
  document.querySelectorAll('.dup-btn').forEach(btn=>{
    btn.removeEventListener('click', onDup);
    btn.addEventListener('click', onDup);
  });
  document.querySelectorAll('.edit-btn').forEach(b=>{
    b.removeEventListener('click', onEdit);
    b.addEventListener('click', onEdit);
  });
  document.getElementById('sel-all').onchange = function(){
    document.querySelectorAll('.sel-item').forEach(cb=>cb.checked = this.checked);
  };
}

function onDup(e){
  const idx = Number(e.currentTarget.dataset.idx);
  const row = chamados[idx];
  const currentAtendente = document.getElementById('atendente').value.trim();
  if(row.Atendente && currentAtendente !== row.Atendente){
    alert('Somente o atendente que criou este chamado pode duplic√°-lo.');
    return;
  }
  const dt = nowDateTime();
  const dup = {...row, Data: dt.date, Hora: dt.time};
  chamados.push(dup);
  saveLocal();
  renderTabela(document.getElementById('search').value);
  if(API_URL) fetch(API_URL, {method:'POST', body: JSON.stringify(dup)}).catch(()=>{});
}

function onEdit(e){
  const idx = Number(e.currentTarget.dataset.idx);
  const rowData = chamados[idx];
  const currentAtendente = document.getElementById('atendente').value.trim();
  if(rowData.Atendente && currentAtendente !== rowData.Atendente){
    alert('Somente o atendente que criou este chamado pode editar.');
    return;
  }
  // simple inline prompt editor (fast on tablet). If prefer modal we can upgrade.
  const novoPaciente = prompt('Editar Nome do paciente:', rowData.Paciente);
  if(novoPaciente === null) return;
  rowData.Paciente = novoPaciente;
  rowData.Telefone = prompt('Telefone:', rowData.Telefone) || rowData.Telefone;
  rowData.Endereco = prompt('Endere√ßo:', rowData.Endereco) || rowData.Endereco;
  rowData.Numero = prompt('N√∫mero:', rowData.Numero) || rowData.Numero;
  rowData.Destino = prompt('Destino:', rowData.Destino) || rowData.Destino;
  rowData.Prioridade = prompt('Prioridade:', rowData.Prioridade) || rowData.Prioridade;
  rowData.Observacoes = prompt('Observa√ß√µes:', rowData.Observacoes) || rowData.Observacoes;
  chamados[idx] = rowData;
  saveLocal();
  renderTabela(document.getElementById('search').value);
  if(API_URL) fetch(API_URL, {method:'POST', body: JSON.stringify(rowData)}).catch(()=>{});
}

/* ---------- excluir selecionados ---------- */
document.getElementById('btn-excluir').addEventListener('click', ()=>{
  const checked = Array.from(document.querySelectorAll('.sel-item:checked'));
  if(checked.length===0) { alert('Nenhum chamado selecionado'); return; }
  if(!confirm(`Excluir ${checked.length} chamados selecionados?`)) return;
  const currentAtend = document.getElementById('atendente').value.trim();
  let cant = 0;
  checked.forEach(cb=>{
    const tr = cb.closest('tr');
    const idx = Number(tr.dataset.index);
    const rowAtend = chamados[idx].Atendente || '';
    if(rowAtend && rowAtend !== currentAtend){ cant++; return; }
    chamados[idx] = null;
  });
  chamados = chamados.filter(x=>x);
  saveLocal();
  renderTabela(document.getElementById('search').value);
  if(cant>0) alert(`${cant} chamado(s) n√£o puderam ser exclu√≠dos porque pertencem a outro atendente.`);
});

/* ---------- export CSV ---------- */
document.getElementById('btn-exportar').addEventListener('click', ()=>{
  if(chamados.length===0){ alert('Sem dados para exportar'); return; }
  const header = ['Data','Hora','Paciente','Endereco','Numero','Telefone','Chamado','Destino','Prioridade','Atendente','Motorista','Observacoes'];
  const rows = [header.join(',')];
  chamados.forEach(r=>{
    const line = [
      r.Data, r.Hora, r.Paciente, r.Endereco, r.Numero, r.Telefone, r.Chamado, r.Destino, r.Prioridade, r.Atendente, r.Motorista, r.Observacoes
    ].map(cell=>`"${(cell||'').toString().replace(/"/g,'""')}"`).join(',');
    rows.push(line);
  });
  const csv = rows.join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `chamados_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
});

/* ---------- relatorio mensal ---------- */
document.getElementById('btn-relatorio').addEventListener('click', ()=>{
  const hoje = new Date(); const mes = hoje.getMonth(); const ano = hoje.getFullYear();
  const chamadosMes = chamados.filter(c=>{
    if(!c.Data) return false;
    const parts = c.Data.split('/'); if(parts.length<3) return false;
    const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return d.getMonth()===mes && d.getFullYear()===ano;
  });
  const tipos = {Normal:0,Urg√™ncia:0, Emerg√™ncia:0};
  const prioridades = {};
  const destinos = {};
  chamadosMes.forEach(c=>{
    const t = (c.Chamado||'').toLowerCase();
    if(t.includes('urg')) tipos['Urg√™ncia']++;
    else if(t.includes('emerg')) tipos['Emerg√™ncia']++;
    else tipos['Normal']++;
    prioridades[c.Prioridade || 'N√£o definida'] = (prioridades[c.Prioridade]||0)+1;
    destinos[c.Destino || 'N√£o definido'] = (destinos[c.Destino]||0)+1;
  });
  let csv = `Relat√≥rio mensal - ${hoje.toLocaleDateString()}\n\nTipo,Quantidade\n`;
  for(const k in tipos) csv += `${k},${tipos[k]}\n`;
  csv += `\nPrioridade,Quantidade\n`;
  for(const p in prioridades) csv += `${p},${prioridades[p]}\n`;
  csv += `\nDestino,Quantidade\n`;
  for(const d in destinos) csv += `${d},${destinos[d]}\n`;
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `relatorio_mensal_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
});

/* ---------- grafico mensal ---------- */
let chart;
function atualizarGraficoMensal(){
  const ctx = document.getElementById('graficoMensal').getContext('2d');
  const hoje = new Date(); const mes = hoje.getMonth(); const ano = hoje.getFullYear();
  const chamadosMes = chamados.filter(c=>{
    if(!c.Data) return false;
    const parts = c.Data.split('/'); if(parts.length<3) return false;
    const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return d.getMonth()===mes && d.getFullYear()===ano;
  });
  const counts = {normal:0, urgencia:0, emergencia:0};
  chamadosMes.forEach(c=>{
    const k = (c.Chamado||'').toLowerCase();
    if(k.includes('urg')) counts.urgencia++;
    else if(k.includes('emerg')) counts.emergencia++;
    else counts.normal++;
  });
  const labels = ['Normal','Urg√™ncia','Emerg√™ncia'];
  const data = [counts.normal, counts.urgencia, counts.emergencia];
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets:[{ label:'Chamados (m√™s)', data, backgroundColor:['#2ecc71','#f1c40f','#e74c3c'] }]},
    options: { responsive:true, plugins:{ legend:{display:false} } }
  });
}

/* ---------- busca em tempo real ---------- */
document.getElementById('search').addEventListener('input', (e)=>{
  renderTabela(e.target.value);
});

/* ---------- adicionar novas op√ß√µes via prompt ---------- */
function promptAddOption(message, list, selId){
  const v = prompt(message);
  if(!v) return;
  // avoid duplicates
  if(list && !list.includes(v)) list.push(v);
  const sel = document.getElementById(selId);
  const opt = document.createElement('option'); opt.value = v; opt.text = v; sel.appendChild(opt);
  sel.value = v;
  localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridades: getSelectOptions('prioridade'), destinos: getSelectOptions('destino')}));
}
document.getElementById('btn-add-endereco-manual').addEventListener('click', ()=> promptAddOption('Digite novo endere√ßo:', enderecoLista, 'endereco'));
document.getElementById('btn-add-endereco').addEventListener('click', ()=> promptAddOption('Digite novo endere√ßo:', enderecoLista, 'endereco'));
document.getElementById('add-destino').addEventListener('click', ()=> { promptAddOption('Digite novo destino:', [], 'destino'); });
document.getElementById('add-prioridade').addEventListener('click', ()=> { promptAddOption('Digite nova prioridade:', [], 'prioridade'); });

/* ---------- atualizar endere√ßos (tenta buscar da fonte; se CORS bloquear, instru√ß√µes) ---------- */
document.getElementById('btn-atualizar-enderecos').addEventListener('click', async ()=>{
  const source = prompt('Cole a URL da fonte de endere√ßos (ex: https://cep.guiamais.com.br/sp/guaicara/logradouros):');
  if(!source) return;
  try{
    const res = await fetch(source);
    if(!res.ok) throw new Error('Erro ao buscar lista (status '+res.status+')');
    const text = await res.text();
    // tentativa heur√≠stica simples: extrair nomes de logradouro (palavras comuns)
    const matches = Array.from(text.matchAll(/>([^<]*?(?:Rua|R |Avenida|Av |Alameda|Pra√ßa|Tv |Travessa|Via de Acesso)[^<]*)</gi)).map(m=>m[1].trim());
    if(matches.length>0){
      matches.forEach(m=>{ if(!enderecoLista.includes(m)) enderecoLista.push(m); });
      populateEnderecoOptions();
      alert('Endere√ßos atualizados ('+matches.length+') ‚Äî verifique a lista.');
      localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridades: getSelectOptions('prioridade'), destinos: getSelectOptions('destino')}));
    } else {
      alert('N√£o foi poss√≠vel detectar endere√ßos automaticamente (prov√°vel bloqueio CORS). Use o bot√£o ‚ûï para adicionar manualmente ou crie um Apps Script para fornecer um JSON/CSV sem CORS.');
    }
  }catch(err){
    console.warn(err);
    alert('Falha ao atualizar (CORS ou formato da p√°gina). Recomendo: 1) criar um Apps Script que retorne o CSV/JSON ou 2) usar o bot√£o ‚ûï para acrescentar manualmente.');
  }
});

/* ---------- salvar / carregar local ---------- */
function saveLocal(){
  try{
    localStorage.setItem('chamados_backup', JSON.stringify(chamados));
  }catch(e){ console.warn('Erro salvar local', e); }
}
function loadLocal(){
  try{
    const s = localStorage.getItem('chamados_backup');
    if(s) chamados = JSON.parse(s);
  }catch(e){ console.warn('Erro ler local', e); }
}

/* ---------- carregar op√ß√µes salvas ---------- */
function loadSavedOptions(){
  try{
    const s = localStorage.getItem('app_options');
    if(s){
      const obj = JSON.parse(s);
      if(obj.enderecoLista) {
        // merge saved addresses with built-in list
        obj.enderecoLista.forEach(e=>{ if(!enderecoLista.includes(e)) enderecoLista.push(e); });
      }
      if(obj.prioridades){
        const sel = document.getElementById('prioridade'); sel.innerHTML = '<option value="">Selecione a prioridade</option>';
        obj.prioridades.forEach(p=> { const o = document.createElement('option'); o.value=p; o.text=p; sel.appendChild(o); });
      }
      if(obj.destinos){
        const sel = document.getElementById('destino'); sel.innerHTML = '<option value="">Selecione o destino</option>';
        obj.destinos.forEach(p=> { const o = document.createElement('option'); o.value=p; o.text=p; sel.appendChild(o); });
      }
    }
  }catch(e){ console.warn(e); }
}

/* ---------- inicializa√ß√£o ---------- */
async function inicializar(){
  loadSavedOptions();
  populateEnderecoOptions();
  if(!getSelectOptions('prioridade').length) populatePrioridadeDestinoDefaults();
  if(!getSelectOptions('destino').length) populatePrioridadeDestinoDefaults(); // ensures destino initial values too (function handles both)
  loadLocal();
  await carregarCSVinicial();
  renderTabela();
  document.getElementById('adicionar').addEventListener('click', adicionarChamado);
  setInterval(saveLocal, 15000);
}
inicializar();

/* ---------- imagem fallback (se der erro no src) ---------- */
document.getElementById('logoImg').addEventListener('error', function(){
  // fallback to inline SVG ambulance
  this.style.display = 'none';
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute('width','56'); svg.setAttribute('height','56'); svg.setAttribute('viewBox','0 0 64 64');
  svg.innerHTML = '<rect width="64" height="64" rx="8" fill="#b71c1c"></rect><path d="M10 40h36v8H10z" fill="#fff" opacity="0.9"></path><circle cx="18" cy="50" r="4" fill="#222"></circle><circle cx="34" cy="50" r="4" fill="#222"></circle><text x="32" y="36" font-size="12" text-anchor="middle" fill="#fff" font-family="Arial">192</text>';
  this.parentNode.insertBefore(svg, this);
});

/* optional: update UI when atendente typed */
document.getElementById('atendente').addEventListener('change', ()=>{
  // small console log helpful for debugging in tablet
  console.log('Atendente atual:', document.getElementById('atendente').value.trim());
});
</script>
</body>
</html>
