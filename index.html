<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --samu-dark:#7a1212;
  --samu-red:#c92b2b;
  --samu-yellow:#f1c40f;
  --samu-green:#2ecc71;
  --blue:#2b7bd3;
  --card:#fff;
  --bg:#f5f6f8;
  --muted:#6b7280;
  --glass: rgba(255,255,255,0.85);
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;margin:18px;background:linear-gradient(180deg,#f7f9fb, #eef2f6);color:#111}
.header-wrap{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.header-card{display:flex;align-items:center;background:var(--samu-dark);color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);flex:1}
.header-img{height:56px;width:56px;border-radius:8px;background:#fff;padding:6px;object-fit:contain;flex:0 0 56px}
.header-title{margin:0;font-weight:700;font-size:18px}
.toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.primary{background:var(--samu-red);color:#fff}
.btn.blue{background:var(--blue);color:#fff}
.btn.green{background:var(--samu-green);color:#fff}
.btn.warn{background:#f39c12;color:#fff}
.btn.purple{background:#8e44ad;color:#fff}
.search-input{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;width:320px}
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:12px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.input, select, button[type="button"]{padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:transparent;font-size:14px}
.add-small{padding:8px 10px;border-radius:8px;border:0;background:var(--blue);color:#fff;cursor:pointer}
.table-card{overflow:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}
th{background:var(--samu-dark);color:#fff;position:sticky;top:0}
tr:hover td{background:#fbfcfd}
.status{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;font-size:12px}
.status.normal{background:var(--samu-green);color:#fff}
.status.urgencia{background:var(--samu-yellow);color:#111}
.status.emergencia{background:var(--samu-red);color:#fff}
.duplicado td{background:#2b7bd3;color:#fff}
.alerta td{animation:pulse 1.2s infinite;border:2px solid orange}
@keyframes pulse{0%{background:#fff4db}50%{background:#fff0c2}100%{background:#fff4db}}
.small-muted{font-size:13px;color:var(--muted)}
.chat-input{width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111}
.footer-note{font-size:13px;color:var(--muted);margin-top:8px}
.icon{font-size:14px}
@media (max-width:900px){.search-input{width:100%}header h1{font-size:16px}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-wrap">
  <div class="header-card">
    <img id="logo" class="header-img" src="https://drive.google.com/uc?export=view&id=1ISJU9dEUo14fePstTcknKWKhsf_hixgB" alt="Ambul√¢ncia 192">
    <div>
      <h1 class="header-title">Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</h1>
      <div class="small-muted">Tema SAMU ‚Ä¢ moderno ‚Ä¢ multi-usu√°rio (simples)</div>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;gap:8px;">
    <button id="btnImportBase64" class="btn purple" title="Colar imagem em base64 (fixa)">üì§ Importar imagem (base64)</button>
    <button id="btnClearImage" class="btn" style="background:#fff;border:1px solid #eee">üßπ Reset Imagem</button>
  </div>
</div>

<!-- CONTROLS -->
<div class="toolbar">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="btnExcluir" class="btn primary">üóëÔ∏è Excluir Selecionados</button>
    <button id="btnExportar" class="btn blue">üì• Exportar CSV</button>
    <button id="btnRelatorio" class="btn green">üìä Relat√≥rio Mensal</button>
    <button id="btnAtualizarEnd" class="btn warn">üîÑ Atualizar Endere√ßos</button>
    <button id="btnAddEndereco" class="btn">‚ûï Acrescentar Endere√ßo</button>
  </div>
  <input id="search" class="search-input" placeholder="Buscar paciente, motorista, destino ou observa√ß√£o..." />
</div>

<!-- FORM -->
<div class="panel">
  <form id="formChamado" onsubmit="return false;">
    <div class="form-grid">
      <input id="nome" class="input" placeholder="Nome do paciente" required>
      <input id="telefone" class="input" placeholder="Telefone">
      <div style="display:flex;gap:8px">
        <select id="endereco" aria-label="Endere√ßo" style="flex:1"></select>
        <button id="btnAddEnderecoManual" type="button" class="add-small">‚ûï</button>
      </div>

      <input id="numero" class="input" placeholder="N√∫mero">
      <select id="chamado" class="input">
        <option value="normal">Normal</option>
        <option value="urgencia">Urg√™ncia</option>
        <option value="emergencia">Emerg√™ncia</option>
      </select>

      <div style="display:flex;gap:8px">
        <select id="destino" class="input" style="flex:1"></select>
        <button id="btnAddDestino" type="button" class="add-small">‚ûï</button>
      </div>

      <div style="display:flex;gap:8px">
        <select id="prioridade" class="input" style="flex:1"></select>
        <button id="btnAddPrioridade" type="button" class="add-small">‚ûï</button>
      </div>

      <input id="atendente" class="input" placeholder="Atendente (seu nome)" required>
      <input id="motorista" class="input" placeholder="Motorista">
      <input id="observacoes" class="input" placeholder="Observa√ß√µes">

      <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnAdicionar" type="button" class="btn primary">‚ûï Adicionar Chamado</button>
      </div>
    </div>
  </form>
  <div class="footer-note">Aten√ß√£o: apenas o atendente que criou um chamado poder√° edit√°-lo/duplic√°-lo/exclu√≠-lo.</div>
</div>

<!-- TABELA -->
<div class="panel table-card" aria-live="polite">
  <table id="tabelaChamados" aria-label="Tabela de chamados">
    <thead>
      <tr>
        <th><input id="selAll" type="checkbox"></th>
        <th>Data</th><th>Hora</th><th>Paciente</th><th>Endere√ßo</th><th>N√∫mero</th><th>Telefone</th>
        <th>Chamado</th><th>Destino</th><th>Prioridade</th><th>Atendente</th><th>Motorista</th><th>Observa√ß√µes</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- CHAT (local, non-persistent) -->
<div class="panel">
  <input id="chat" class="chat-input" placeholder="Chat interno (mensagens tempor√°rias ‚Äî apenas para leitura local)" />
</div>

<!-- GR√ÅFICO -->
<div class="panel">
  <h3 class="section-title">Gr√°fico Mensal de Chamados</h3>
  <canvas id="graficoMensal" height="120"></canvas>
</div>

<script>
/* ---------------- CONFIG ---------------- */
// CSV p√∫blico (usei o link que voc√™ enviou, com gid e output=csv)
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3_8QPyI7v109xYun_zxMKwqpoSmzPwbGaB4kvyHizG4IeJjR9ZGZHr1VF5WKsJWhcMFYnqeuosmrU/pub?gid=140252754&single=true&output=csv";

/* Built-in list of endere√ßos (aumentamos com os que voc√™ pediu) */
let enderecoLista = [
  "Av Duque de Caxias","Av Nove de Julho","Rua Rui Barbosa","Rua Ot√°vio Maitan",
  "Avenida Brasil","Rua XV de Novembro","Alameda das Rosas","Pra√ßa Central"
];
/* Prioridades e destinos iniciais */
let prioridadeLista = ["Nenhuma","Curativo","Doen√ßas cr√¥nicas ou complica√ß√µes","Urg√™ncia","Emerg√™ncia","Normal","P√≥s-consulta"];
let destinoLista = ["Hospital Municipal","UPA","CSIII"];

/* App state */
let chamados = []; // array of objects
let chart = null;

/* ---------------- HELPERS ---------------- */
const $ = id => document.getElementById(id);
function nowDateTime(){
  const d=new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return {date:`${dd}/${mm}/${yyyy}`, time:`${hh}:${min}`};
}
function saveLocal(){
  localStorage.setItem('chamados_guai', JSON.stringify(chamados));
}
function loadLocal(){
  const s = localStorage.getItem('chamados_guai');
  if(s) chamados = JSON.parse(s);
}

/* ---------------- POPULATE SELECTS ---------------- */
function populateSelects(){
  const end = $('endereco'); end.innerHTML = '<option value="">Selecione...</option>';
  enderecoLista.forEach(e => { const o = new Option(e, e); end.add(o); });
  const pri = $('prioridade'); pri.innerHTML = '<option value="">Selecione...</option>';
  prioridadeLista.forEach(p => { pri.add(new Option(p,p)); });
  const des = $('destino'); des.innerHTML = '<option value="">Selecione...</option>';
  destinoLista.forEach(d => { des.add(new Option(d,d)); });
}

/* ---------------- PARSE CSV (robusto para aspas) ---------------- */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return [];
  const headers = lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
  const rows = lines.slice(1);
  const out = rows.map(r=>{
    const cols=[]; let cur='', inQ=false;
    for(let i=0;i<r.length;i++){
      const ch=r[i];
      if(ch === '"'){ if(inQ && r[i+1]==='"'){ cur+='"'; i++; } else inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; continue; }
      cur += ch;
    }
    cols.push(cur);
    const obj={};
    for(let i=0;i<headers.length;i++) obj[headers[i]] = (cols[i]||'').replace(/^"|"$/g,'').trim();
    return obj;
  });
  return out;
}

/* ---------------- LOAD CSV (once) ---------------- */
async function carregarCSV(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('status '+res.status);
    const txt = await res.text();
    const parsed = parseCSV(txt);
    if(parsed.length){
      // Map to our internal format (best-effort header names)
      parsed.forEach(row => {
        const item = {
          Data: row['Data'] || row['data'] || row['Date'] || '',
          Hora: row['Hora'] || row['hora'] || row['Time'] || '',
          Paciente: row['Paciente'] || row['Nome'] || row['nome'] || '',
          Endereco: row['Endere√ßo'] || row['Endereco'] || row['logradouro'] || '',
          Numero: row['N√∫mero'] || row['Numero'] || '',
          Telefone: row['Telefone'] || row['telefone'] || '',
          Chamado: (row['Chamado'] || row['Tipo'] || row['tipo'] || 'normal').toLowerCase(),
          Destino: row['Destino'] || row['destino'] || '',
          Prioridade: row['Prioridade'] || row['prioridade'] || '',
          Atendente: row['Atendente'] || row['atendente'] || '',
          Motorista: row['Motorista'] || row['motorista'] || '',
          Observacoes: row['Observa√ß√µes'] || row['Observacoes'] || row['Obs'] || ''
        };
        chamados.push(item);
      });
      saveLocal();
      renderTabela();
    }
  }catch(err){
    console.warn('Falha ao carregar CSV (CORS ou outro):', err);
    // fallback: if localStorage has backup, load it (already done), otherwise nothing
    renderTabela();
  }
}

/* ---------------- RENDER TABLE ---------------- */
function renderTabela(filter=''){
  const tbody = document.querySelector('#tabelaChamados tbody');
  tbody.innerHTML = '';
  chamados.forEach((c, i) => {
    const text = (c.Paciente + c.Telefone + c.Endereco + c.Atendente + c.Destino + c.Observacoes).toLowerCase();
    if(filter && !text.includes(filter.toLowerCase())) return;
    // duplicated same patient same date => blue row for duplicates
    const duplicadosHoje = chamados.filter(x => x.Paciente === c.Paciente && x.Data === c.Data).length > 1;
    const totalMesmo = chamados.filter(x => x.Data === c.Data).length;
    const tr = document.createElement('tr');
    if(duplicadosHoje) tr.classList.add('duplicado');
    if(totalMesmo > 3) tr.classList.add('alerta');
    const chamadoClass = c.Chamado === 'urgencia' ? 'urgencia' : (c.Chamado === 'emergencia' ? 'emergencia' : 'normal');
    tr.innerHTML = `
      <td><input class="sel-item" type="checkbox" data-i="${i}"></td>
      <td>${c.Data||''}</td>
      <td>${c.Hora||''}</td>
      <td>${c.Paciente||''}</td>
      <td>${c.Endereco||''}</td>
      <td>${c.Numero||''}</td>
      <td>${c.Telefone||''}</td>
      <td><span class="status ${chamadoClass}">${(c.Chamado||'').toUpperCase()}</span></td>
      <td>${c.Destino||''}</td>
      <td>${c.Prioridade||''}</td>
      <td>${c.Atendente||''}</td>
      <td>${c.Motorista||''}</td>
      <td>${c.Observacoes||''}</td>
      <td>
        <button class="btn" data-action="dup" data-i="${i}">‚ûï</button>
        <button class="btn" data-action="edit" data-i="${i}">‚úèÔ∏è</button>
        <button class="btn" data-action="del" data-i="${i}">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  attachTableEvents();
  atualizarGrafico();
}

/* ---------------- ATTACH EVENTS ---------------- */
function attachTableEvents(){
  document.querySelectorAll('[data-action]').forEach(btn=>{
    btn.onclick = (e)=>{
      const action = e.currentTarget.dataset.action;
      const i = Number(e.currentTarget.dataset.i);
      const currentAtendente = $('atendente').value.trim();
      const rowAtendente = chamados[i].Atendente || '';
      if(action === 'dup'){
        // only creator can duplicate
        if(rowAtendente && currentAtendente !== rowAtendente){ alert('Somente o atendente que criou pode duplicar.'); return; }
        const dt = nowDateTime();
        const dup = {...chamados[i], Data: dt.date, Hora: dt.time};
        chamados.push(dup); saveLocal(); renderTabela($('search').value);
        return;
      }
      if(action === 'edit'){
        if(rowAtendente && currentAtendente !== rowAtendente){ alert('Somente o atendente que criou pode editar.'); return; }
        // inline edit via prompt (fast for tablet). Could be replaced by modal.
        const novo = prompt('Editar nome do paciente:', chamados[i].Paciente);
        if(novo === null) return;
        chamados[i].Paciente = novo;
        chamados[i].Telefone = prompt('Telefone:', chamados[i].Telefone) || chamados[i].Telefone;
        chamados[i].Endereco = prompt('Endere√ßo:', chamados[i].Endereco) || chamados[i].Endereco;
        chamados[i].Numero = prompt('N√∫mero:', chamados[i].Numero) || chamados[i].Numero;
        chamados[i].Destino = prompt('Destino:', chamados[i].Destino) || chamados[i].Destino;
        chamados[i].Prioridade = prompt('Prioridade:', chamados[i].Prioridade) || chamados[i].Prioridade;
        chamados[i].Observacoes = prompt('Observa√ß√µes:', chamados[i].Observacoes) || chamados[i].Observacoes;
        saveLocal(); renderTabela($('search').value);
        return;
      }
      if(action === 'del'){
        if(rowAtendente && currentAtendente !== rowAtendente){ alert('Somente o atendente que criou pode excluir.'); return; }
        if(!confirm('Confirmar exclus√£o deste chamado?')) return;
        chamados.splice(i,1); saveLocal(); renderTabela($('search').value);
        return;
      }
    };
  });
  // selAll behavior
  $('selAll').onchange = function(){ document.querySelectorAll('.sel-item').forEach(c=>c.checked = this.checked); };
}

/* ---------------- ADD / DELETE / EXPORT ---------------- */
$('btnAdicionar').onclick = ()=>{
  const nome = $('nome').value.trim(); const atendente = $('atendente').value.trim();
  if(!nome || !atendente) { alert('Preencha nome do paciente e atendente.'); return; }
  const dt = nowDateTime();
  const obj = {
    Data: dt.date,
    Hora: dt.time,
    Paciente: nome,
    Endereco: $('endereco').value || '',
    Numero: $('numero').value || '',
    Telefone: $('telefone').value || '',
    Chamado: $('chamado').value || 'normal',
    Destino: $('destino').value || '',
    Prioridade: $('prioridade').value || '',
    Atendente: atendente,
    Motorista: $('motorista').value || '',
    Observacoes: $('observacoes').value || ''
  };
  chamados.push(obj);
  saveLocal();
  renderTabela($('search').value);
  // clear fields
  $('nome').value=''; $('telefone').value=''; $('numero').value=''; $('observacoes').value='';
};

/* excluir selecionados (respeita atendente) */
$('btnExcluir').onclick = ()=>{
  const checked = Array.from(document.querySelectorAll('.sel-item:checked'));
  if(!checked.length){ alert('Nenhum chamado selecionado'); return; }
  if(!confirm(`Excluir ${checked.length} chamados selecionados?`)) return;
  const currentAtendente = $('atendente').value.trim();
  // compute indices to remove
  const indices = checked.map(cb => Array.from(cb.closest('tr').parentNode.children).indexOf(cb.closest('tr')));
  // filter keeping those not selected OR those selected but created by other atendente (can't delete)
  let cantBlocked = 0;
  chamados = chamados.filter((c, idx) => {
    if(indices.includes(idx)){
      if(c.Atendente && currentAtendente !== c.Atendente){ cantBlocked++; return true; }
      return false; // remove
    }
    return true;
  });
  saveLocal(); renderTabela($('search').value);
  if(cantBlocked) alert(`${cantBlocked} chamado(s) n√£o foram exclu√≠dos porque pertencem a outro atendente.`);
};

/* export CSV */
$('btnExportar').onclick = ()=>{
  if(!chamados.length){ alert('Sem dados para exportar'); return; }
  const header = ['Data','Hora','Paciente','Endereco','Numero','Telefone','Chamado','Destino','Prioridade','Atendente','Motorista','Observacoes'];
  const rows = [header.join(',')];
  chamados.forEach(r=>{
    const line = [r.Data,r.Hora,r.Paciente,r.Endereco,r.Numero,r.Telefone,r.Chamado,r.Destino,r.Prioridade,r.Atendente,r.Motorista,r.Observacoes]
      .map(cell => `"${(cell||'').toString().replace(/"/g,'""')}"`).join(',');
    rows.push(line);
  });
  const csv = rows.join('\n');
  const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `chamados_guai_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};

/* relatorio (gera CSV com totais) */
$('btnRelatorio').onclick = ()=>{
  const hoje = new Date(); const mes = hoje.getMonth(); const ano = hoje.getFullYear();
  const chamadosMes = chamados.filter(c => {
    if(!c.Data) return false;
    const parts = c.Data.split('/'); if(parts.length<3) return false;
    const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return d.getMonth()===mes && d.getFullYear()===ano;
  });
  const tipos = {Normal:0,Urg√™ncia:0, Emerg√™ncia:0};
  const prioridades = {}; const destinos = {};
  chamadosMes.forEach(c=>{
    const t = (c.Chamado||'').toLowerCase();
    if(t.includes('urg')) tipos['Urg√™ncia']++;
    else if(t.includes('emerg')) tipos['Emerg√™ncia']++;
    else tipos['Normal']++;
    prioridades[c.Prioridade||'N√£o definida'] = (prioridades[c.Prioridade]||0)+1;
    destinos[c.Destino||'N√£o definido'] = (destinos[c.Destino]||0)+1;
  });
  let csv = `Relat√≥rio mensal - ${hoje.toLocaleDateString('pt-BR')}\n\nTipo,Quantidade\n`;
  Object.keys(tipos).forEach(k => csv += `${k},${tipos[k]}\n`);
  csv += '\nPrioridade,Quantidade\n'; Object.keys(prioridades).forEach(k=> csv+= `${k},${prioridades[k]}\n`);
  csv += '\nDestino,Quantidade\n'; Object.keys(destinos).forEach(k=> csv+= `${k},${destinos[k]}\n`);
  const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `relatorio_mensal_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};

/* ---------------- ADD OPTIONS ---------------- */
$('btnAddEndereco').onclick = ()=> promptAddOption('Digite novo endere√ßo:', enderecoLista, 'endereco');
$('btnAddEndereco').addEventListener('click', ()=> {}); // noop for clarity
$('btnAddPrioridade').onclick = ()=> promptAddOption('Digite nova prioridade:', prioridadeLista, 'prioridade');
$('btnAddDestino').onclick = ()=> promptAddOption('Digite novo destino:', destinoLista, 'destino');
$('btnAddEnderecoManual').onclick = ()=> promptAddOption('Digite novo endere√ßo:', enderecoLista, 'endereco');
function promptAddOption(msg, list, selId){
  const v = prompt(msg);
  if(!v) return;
  if(list && !list.includes(v)) list.push(v);
  const sel = $(selId);
  const o = new Option(v,v); sel.add(o); sel.value = v;
  // save options
  localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista}));
}

/* ---------------- UPDATE ENDERE√áOS (try fetch, else user adds manually) ---------------- */
$('btnAtualizarEnd').onclick = async ()=>{
  const source = prompt('Cole a URL da fonte de endere√ßos (ex: https://cep.guiamais.com.br/sp/guaicara/logradouros):');
  if(!source) return;
  try{
    const res = await fetch(source);
    if(!res.ok) throw new Error('status '+res.status);
    const text = await res.text();
    // try to extract probable logradouro names (heuristic)
    const matches = Array.from(text.matchAll(/>([^<]*?(?:Rua|R |Avenida|Av |Alameda|Pra√ßa|Tv |Travessa|Via de Acesso)[^<]*)</gi)).map(m=>m[1].trim());
    if(matches.length){
      matches.forEach(m => { if(!enderecoLista.includes(m)) enderecoLista.push(m); });
      populateSelects(); localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista}));
      alert('Endere√ßos atualizados ('+matches.length+'). Revise a lista.');
    } else {
      alert('N√£o foi poss√≠vel detectar endere√ßos automaticamente. Use o bot√£o ‚ûï para acrescentar manualmente.');
    }
  }catch(err){
    console.warn(err); alert('Falha ao buscar (prov√°vel bloqueio CORS). Use o bot√£o ‚ûï ou crie um Apps Script para fornecer um CSV/JSON sem CORS.');
  }
};

/* ---------------- CHART ---------------- */
function atualizarGrafico(){
  const ctx = document.getElementById('graficoMensal').getContext('2d');
  const counts = {Normal:0,Urg√™ncia:0, Emerg√™ncia:0};
  chamados.forEach(c=>{
    const k = (c.Chamado||'').toLowerCase();
    if(k.includes('urg')) counts['Urg√™ncia']++;
    else if(k.includes('emerg')) counts['Emerg√™ncia']++;
    else counts['Normal']++;
  });
  const labels = Object.keys(counts), data = Object.values(counts);
  if(chart) chart.destroy();
  chart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Chamados', data, backgroundColor:['#2ecc71','#f1c40f','#c92b2b'] }] }, options:{responsive:true,plugins:{legend:{display:false}} }});
}

/* ---------------- IMAGE IMPORT (base64 or try-drive) ---------------- */
$('btnImportBase64').onclick = async ()=>{
  const paste = prompt('Cole aqui a imagem em Base64 (data:image/‚Ä¶). Se voc√™ n√£o souber, cole a URL p√∫blica da imagem (Drive).');
  if(!paste) return;
  // if paste starts with data:, set and persist
  if(paste.startsWith('data:')){
    localStorage.setItem('logo_base64', paste);
    $('logo').src = paste;
    alert('Imagem salva e fixa (base64).');
    return;
  }
  // else try to fetch the URL and convert to base64 in-browser (may fail due to CORS)
  try{
    const res = await fetch(paste);
    if(!res.ok) throw new Error('status '+res.status);
    const blob = await res.blob();
    const reader = new FileReader();
    reader.onloadend = ()=>{ localStorage.setItem('logo_base64', reader.result); $('logo').src = reader.result; alert('Imagem carregada e salva (base64).'); };
    reader.readAsDataURL(blob);
  }catch(err){
    console.warn(err);
    alert('Falha ao buscar/convertir automaticamente (prov√°vel CORS). Voc√™ pode abrir a imagem localmente, convert√™-la para base64 (h√° sites/tools) e colar o resultado aqui.');
  }
};
$('btnClearImage').onclick = ()=>{
  localStorage.removeItem('logo_base64');
  $('logo').src = 'https://drive.google.com/uc?export=view&id=1ISJU9dEUo14fePstTcknKWKhsf_hixgB';
  alert('Imagem resetada (tente novamente a importa√ß√£o se quiser fixar em base64).');
};

/* ---------------- SEARCH ---------------- */
$('search').addEventListener('input', (e)=> renderTabela(e.target.value));

/* ---------------- SAVE OPTIONS RESTORE ---------------- */
function loadAppOptions(){
  try{
    const s = localStorage.getItem('app_options');
    if(!s) return;
    const o = JSON.parse(s);
    if(o.enderecoLista) enderecoLista = Array.from(new Set([...enderecoLista, ...o.enderecoLista]));
    if(o.prioridadeLista) prioridadeLista = Array.from(new Set([...prioridadeLista, ...o.prioridadeLista]));
    if(o.destinoLista) destinoLista = Array.from(new Set([...destinoLista, ...o.destinoLista]));
  }catch(e){ console.warn(e); }
}

/* ---------------- INIT ---------------- */
async function init(){
  // restore logo if base64 saved
  const base = localStorage.getItem('logo_base64'); if(base) $('logo').src = base;
  loadAppOptions();
  populateSelects();
  loadLocal();
  await carregarCSV(); // tries CSV (falls back to local)
  renderTabela();
  // save beforeunload
  window.addEventListener('beforeunload', ()=> saveLocal());
}
init();
</script>
</body>
</html>
