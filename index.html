<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --samu-dark:#7a1212;
  --samu-red:#c92b2b;
  --samu-yellow:#f1c40f;
  --samu-green:#2ecc71;
  --blue:#2b7bd3;
  --card:#fff;
  --bg:#f5f6f8;
  --muted:#6b7280;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;margin:0;background:linear-gradient(180deg,#f7f9fb,#eef2f6);color:#111}
.header-wrap{display:flex;align-items:center;gap:14px;padding:18px}
.header-card{display:flex;align-items:center;background:var(--samu-dark);color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);flex:1}
.header-img{height:56px;width:56px;border-radius:8px;background:#fff;padding:6px;object-fit:contain;flex:0 0 56px}
.header-title{margin:0;font-weight:700;font-size:18px}
.toolbar{display:flex;gap:8px;align-items:center;margin:10px 18px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.primary{background:var(--samu-red);color:#fff}
.btn.blue{background:var(--blue);color:#fff}
.btn.green{background:var(--samu-green);color:#fff}
.btn.warn{background:#f39c12;color:#fff}
.search-input{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;width:320px}
.container{padding:0 18px 120px 18px}
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:12px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.input, select{padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:transparent;font-size:14px}
.add-small{padding:8px 10px;border-radius:8px;border:0;background:var(--blue);color:#fff;cursor:pointer}
.table-card{overflow:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}
th{background:var(--samu-dark);color:#fff;position:sticky;top:0;z-index:2}
tr:hover td{background:#fbfcfd}
.status{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;font-size:12px}
.status.normal{background:var(--samu-green);color:#fff}
.status.urgencia{background:var(--samu-yellow);color:#111}
.status.emergencia{background:var(--samu-red);color:#fff}
.duplicado td{background:#2b7bd3;color:#fff}
.alerta td{animation:pulse 1.2s infinite;border:2px solid orange}
@keyframes pulse{0%{background:#fff4db}50%{background:#fff0c2}100%{background:#fff4db}}
.small-muted{font-size:13px;color:var(--muted)}
.chat-footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;padding:8px 12px;display:flex;gap:8px;align-items:center;z-index:6}
.chat-input{flex:1;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
.chat-send{padding:8px 12px;border-radius:8px;border:0;background:var(--blue);color:#fff;cursor:pointer}
.chat-list{max-height:160px;overflow:auto;padding:6px;border-radius:8px;border:1px solid #eee;background:#fafafa;margin-bottom:8px}
.footer-small{font-size:12px;color:#777}
@media (max-width:900px){.search-input{width:100%}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-wrap">
  <div class="header-card" style="flex:1">
    <img id="logoImg" class="header-img" src="https://drive.google.com/uc?export=view&id=1ISJU9dEUo14fePstTcknKWKhsf_hixgB" alt="Ambul√¢ncia 192">
    <div style="margin-left:12px">
      <h1 class="header-title">Registro de Chamados ‚Äì Ambul√¢ncia Municipal ‚Äì Guai√ßara/SP</h1>
      <div class="small-muted">Tema SAMU ‚Äî sincroniza√ß√£o em tempo real (Firebase)</div>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;gap:8px;">
    <button id="btnImportBase64" class="btn warn">üì§ Importar imagem base64</button>
    <button id="btnResetLogo" class="btn">üîÅ Reset imagem</button>
  </div>
</div>

<!-- CONTROLS -->
<div class="toolbar container">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="btnExcluir" class="btn primary">üóëÔ∏è Excluir Selecionados</button>
    <button id="btnExportar" class="btn blue">üì• Exportar CSV</button>
    <button id="btnRelatorio" class="btn green">üìä Relat√≥rio Mensal</button>
    <button id="btnAtualizarEnd" class="btn warn">üîÑ Atualizar Endere√ßos</button>
    <button id="btnAddEndereco" class="btn">‚ûï Acrescentar Endere√ßo</button>
  </div>
  <input id="search" class="search-input" placeholder="Buscar paciente, motorista, destino ou observa√ß√£o..." />
</div>

<!-- MAIN -->
<div class="container">
  <div class="panel">
    <form id="formChamado" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label for="nome">Nome do paciente</label><br>
          <input id="nome" class="input" placeholder="Nome do paciente" required>
        </div>
        <div>
          <label for="telefone">Telefone</label><br>
          <input id="telefone" class="input" placeholder="Telefone">
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label for="endereco">üìç Endere√ßo</label><br>
            <select id="endereco" class="input" aria-label="Endere√ßo"></select>
          </div>
          <button id="btnAddEnderecoManual" type="button" class="add-small">‚ûï</button>
        </div>

        <div>
          <label for="numero">N√∫mero</label><br>
          <input id="numero" class="input" placeholder="N√∫mero">
        </div>

        <div>
          <label for="chamado">Chamado</label><br>
          <select id="chamado" class="input">
            <option value="normal">Normal</option>
            <option value="urgencia">Urg√™ncia</option>
            <option value="emergencia">Emerg√™ncia</option>
          </select>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label for="destino">Destino</label><br>
            <select id="destino" class="input"></select>
          </div>
          <button id="btnAddDestino" type="button" class="add-small">‚ûï</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label for="prioridade">Prioridade</label><br>
            <select id="prioridade" class="input"></select>
          </div>
          <button id="btnAddPrioridade" type="button" class="add-small">‚ûï</button>
        </div>

        <div>
          <label for="atendente">Atendente (seu nome)</label><br>
          <input id="atendente" class="input" placeholder="Atendente" required>
        </div>

        <div>
          <label for="motorista">Motorista</label><br>
          <input id="motorista" class="input" placeholder="Motorista">
        </div>

        <div style="grid-column:1/-1">
          <label for="observacoes">Observa√ß√µes</label><br>
          <input id="observacoes" class="input" placeholder="Observa√ß√µes">
        </div>

        <div style="grid-column:1/-1;display:flex;justify-content:flex-end">
          <button id="btnAdicionar" type="button" class="btn primary">‚ûï Adicionar Chamado</button>
        </div>
      </div>
    </form>
    <div class="small-muted">Aten√ß√£o: somente o atendente/usu√°rio que criou o chamado poder√° edit√°-lo/duplic√°-lo/exclu√≠-lo.</div>
  </div>

  <div class="panel table-card">
    <table id="tabelaChamados" aria-label="Tabela de chamados">
      <thead>
        <tr>
          <th><input id="selAll" type="checkbox"></th>
          <th>Data</th><th>Hora</th><th>Paciente</th><th>Endere√ßo</th><th>N√∫mero</th><th>Telefone</th>
          <th>Chamado</th><th>Destino</th><th>Prioridade</th><th>Atendente</th><th>Motorista</th><th>Observa√ß√µes</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel">
    <h3 class="section-title">Gr√°fico Mensal de Chamados</h3>
    <canvas id="graficoMensal" height="120"></canvas>
  </div>
</div>

<!-- CHAT FIXED FOOTER -->
<div class="chat-footer">
  <div style="width:360px;max-width:40%;">
    <div class="chat-list" id="chatList"></div>
    <div style="display:flex;gap:8px;">
      <input id="chatInput" class="chat-input" placeholder="Mensagem r√°pida (enter para enviar)">
      <button id="chatSend" class="chat-send">Enviar</button>
    </div>
  </div>
  <div style="flex:1;display:flex;align-items:center;justify-content:flex-end;">
    <div class="footer-small">Conectado ao Firebase ‚Ä¢ Sincroniza√ß√£o em tempo real</div>
  </div>
</div>

<!-- FIREBASE SCRIPTS (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
/* ================== CONFIG (sua config enviada) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyCoSPb1WMrH2MMuM1AdR2YEAX60XVgO3WE",
  authDomain: "registro-ambulancia192.firebaseapp.com",
  databaseURL: "https://registro-ambulancia192-default-rtdb.firebaseio.com",
  projectId: "registro-ambulancia192",
  storageBucket: "registro-ambulancia192.firebasestorage.app",
  messagingSenderId: "549498386461",
  appId: "1:549498386461:web:94d6ac364a54a7d4216ef4",
  measurementId: "G-NM7EQL6E83"
};
/* ================================================================= */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentUID = null;
let chamadosLocal = {}; // mirror of DB
let chart = null;

/* CSV URL (sua planilha publicada) */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3_8QPyI7v109xYun_zxMKwqpoSmzPwbGaB4kvyHizG4IeJjR9ZGZHr1VF5WKsJWhcMFYnqeuosmrU/pub?gid=140252754&single=true&output=csv";

/* inicial lists */
let enderecoLista = ["Av Duque de Caxias","Av Nove de Julho","Rua Rui Barbosa","Rua Ot√°vio Maitan","Avenida Brasil","Rua XV de Novembro","Alameda das Rosas","Pra√ßa Central"];
let prioridadeLista = ["Nenhuma","Curativo","Doen√ßas cr√¥nicas ou complica√ß√µes","Urg√™ncia","Emerg√™ncia","Normal","P√≥s-consulta"];
let destinoLista = ["Hospital Municipal","UPA","CSIII"];

/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
function nowDateTime(){ const d=new Date(); return {date:`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`, time:`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`}; }
function saveLocalBackup(){ localStorage.setItem('chamados_backup', JSON.stringify(chamadosLocal)); }
function parseCSV(text){
  const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim());
  if(!lines.length) return [];
  const headers = lines.shift().split(',').map(h=>h.replace(/(^"|"$)/g,'').trim());
  return lines.map(line=>{
    const cols=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; continue; }
      cur += ch;
    }
    cols.push(cur);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (cols[idx]||'').replace(/(^"|"$)/g,'').trim());
    return obj;
  });
}

/* ---------- populate selects ---------- */
function populateSelects(){
  const end = $('endereco'); end.innerHTML = '<option value="">Selecione...</option>';
  enderecoLista.forEach(e=> end.add(new Option(e,e)));
  const pri = $('prioridade'); pri.innerHTML = '<option value="">Selecione...</option>';
  prioridadeLista.forEach(p=> pri.add(new Option(p,p)));
  const des = $('destino'); des.innerHTML = '<option value="">Selecione...</option>';
  destinoLista.forEach(d=> des.add(new Option(d,d)));
}

/* ---------- AUTH (anonymous) ---------- */
auth.signInAnonymously().catch(()=>{}).then(()=> {
  if(auth.currentUser) {
    currentUID = auth.currentUser.uid;
    console.log('Auth anon OK, uid=', currentUID);
  }
});

/* ---------- Firebase listeners (real-time) ---------- */
const chamadosRef = db.ref('chamados');
const chatRef = db.ref('chat');

chamadosRef.on('value', snap => {
  chamadosLocal = snap.val() || {};
  renderTabelaFromFirebase();
  atualizarGrafico();
});

chatRef.limitToLast(200).on('child_added', snap => {
  const m = snap.val();
  appendChatMessage(m);
});

/* ---------- render tabela (from Firebase) ---------- */
function renderTabelaFromFirebase(filter=''){
  const tbody = $('tabelaChamados').querySelector('tbody');
  tbody.innerHTML = '';
  const keys = Object.keys(chamadosLocal || {});
  keys.forEach((k, idx)=>{
    const c = chamadosLocal[k];
    if(!c) return;
    const text = ((c.Paciente||'') + (c.Telefone||'') + (c.Endereco||'') + (c.Atendente||'') + (c.Destino||'') + (c.Observacoes||'')).toLowerCase();
    if(filter && !text.includes(filter.toLowerCase())) return;
    // duplication logic (same patient same date)
    const duplicadosHoje = keys.filter(kk => {
      const x = chamadosLocal[kk];
      return x && x.Paciente === c.Paciente && x.Data === c.Data;
    }).length > 1;
    const totalMesmo = keys.filter(kk => {
      const x = chamadosLocal[kk];
      return x && x.Data === c.Data;
    }).length;
    const tr = document.createElement('tr');
    if(duplicadosHoje) tr.classList.add('duplicado');
    if(totalMesmo > 3) tr.classList.add('alerta');
    const chamadoClass = (c.Chamado||'').toLowerCase().includes('urg') ? 'urgencia' : ((c.Chamado||'').toLowerCase().includes('emerg') ? 'emergencia' : 'normal');
    tr.dataset.key = k;
    tr.innerHTML = `
      <td><input class="sel-item" type="checkbox" data-key="${k}"></td>
      <td>${c.Data||''}</td>
      <td>${c.Hora||''}</td>
      <td>${c.Paciente||''}</td>
      <td>${c.Endereco||''}</td>
      <td>${c.Numero||''}</td>
      <td>${c.Telefone||''}</td>
      <td><span class="status ${chamadoClass}">${(c.Chamado||'NORMAL').toUpperCase()}</span></td>
      <td>${c.Destino||''}</td>
      <td>${c.Prioridade||''}</td>
      <td>${c.Atendente||''}</td>
      <td>${c.Motorista||''}</td>
      <td>${c.Observacoes||''}</td>
      <td>
        <button class="btn" data-action="dup" data-key="${k}">‚ûï</button>
        <button class="btn" data-action="edit" data-key="${k}">‚úèÔ∏è</button>
        <button class="btn" data-action="del" data-key="${k}">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  attachTableHandlers();
}

/* ---------- attach table handlers ---------- */
function attachTableHandlers(){
  document.querySelectorAll('[data-action]').forEach(btn=>{
    btn.onclick = async (e)=>{
      const action = e.currentTarget.dataset.action;
      const key = e.currentTarget.dataset.key;
      const record = chamadosLocal[key];
      const currentAtendenteName = $('atendente').value.trim();
      const ownerUID = record.createdBy || null;
      // permission check: if auth present, require ownerUID === currentUID
      const canAct = (currentUID && ownerUID && currentUID === ownerUID) || (!currentUID && record.Atendente && record.Atendente === currentAtendenteName);
      if(!canAct){ alert('Somente o atendente/usu√°rio que criou pode realizar esta a√ß√£o.'); return; }
      if(action === 'dup'){
        const dt = nowDateTime();
        const newKey = chamadosRef.push().key;
        const copy = {...record, Data: dt.date, Hora: dt.time, createdBy: currentUID || record.createdBy, createdAt: Date.now()};
        const u = {}; u[newKey] = copy;
        await chamadosRef.update(u);
        return;
      }
      if(action === 'edit'){
        // quick edit via prompts
        const novoPaciente = prompt('Editar nome:', record.Paciente || '');
        if(novoPaciente === null) return;
        const novoTelefone = prompt('Telefone:', record.Telefone || '') || record.Telefone;
        const novoEndereco = prompt('Endere√ßo:', record.Endereco || '') || record.Endereco;
        const novoNumero = prompt('N√∫mero:', record.Numero || '') || record.Numero;
        const novoDestino = prompt('Destino:', record.Destino || '') || record.Destino;
        const novaPrior = prompt('Prioridade:', record.Prioridade || '') || record.Prioridade;
        const novasObs = prompt('Observa√ß√µes:', record.Observacoes || '') || record.Observacoes;
        await chamadosRef.child(key).update({
          Paciente: novoPaciente, Telefone: novoTelefone, Endereco: novoEndereco, Numero: novoNumero,
          Destino: novoDestino, Prioridade: novaPrior, Observacoes: novasObs
        });
        return;
      }
      if(action === 'del'){
        if(!confirm('Confirmar exclus√£o deste chamado?')) return;
        await chamadosRef.child(key).remove();
        return;
      }
    };
  });
  $('selAll').onchange = function(){ document.querySelectorAll('.sel-item').forEach(cb=>cb.checked = this.checked); };
}

/* ---------- adicionar chamado (salva no Firebase) ---------- */
$('btnAdicionar').onclick = async ()=>{
  const nome = $('nome').value.trim(); const atendente = $('atendente').value.trim();
  if(!nome || !atendente){ alert('Preencha nome do paciente e atendente'); return; }
  const dt = nowDateTime();
  const obj = {
    Data: dt.date, Hora: dt.time, Paciente: nome,
    Endereco: $('endereco').value || '', Numero: $('numero').value || '',
    Telefone: $('telefone').value || '', Chamado: $('chamado').value || 'normal',
    Destino: $('destino').value || '', Prioridade: $('prioridade').value || '',
    Atendente: atendente, Motorista: $('motorista').value || '', Observacoes: $('observacoes').value || '',
    createdBy: currentUID || atendente, createdAt: Date.now()
  };
  const key = chamadosRef.push().key;
  const u = {}; u[key] = obj;
  await chamadosRef.update(u);
  // clear form
  $('nome').value=''; $('telefone').value=''; $('numero').value=''; $('observacoes').value='';
};

/* ---------- excluir selecionados (respeita autor) ---------- */
$('btnExcluir').onclick = async ()=>{
  const checked = Array.from(document.querySelectorAll('.sel-item:checked'));
  if(!checked.length){ alert('Nenhum chamado selecionado'); return; }
  if(!confirm(`Excluir ${checked.length} chamados selecionados?`)) return;
  const currentAtendenteName = $('atendente').value.trim();
  let blocked = 0;
  for(const cb of checked){
    const key = cb.dataset.key;
    const rec = chamadosLocal[key];
    if(!rec) continue;
    const ownerUID = rec.createdBy || null;
    const canAct = (currentUID && ownerUID && currentUID === ownerUID) || (!currentUID && rec.Atendente && rec.Atendente === currentAtendenteName);
    if(!canAct){ blocked++; continue; }
    await chamadosRef.child(key).remove();
  }
  if(blocked) alert(`${blocked} chamado(s) n√£o puderam ser exclu√≠dos ‚Äî pertencem a outro atendente/usu√°rio.`);
};

/* ---------- export CSV (from Firebase snapshot) ---------- */
$('btnExportar').onclick = ()=>{
  const keys = Object.keys(chamadosLocal || {});
  if(!keys.length){ alert('Sem dados para exportar'); return; }
  const header = ['Data','Hora','Paciente','Endereco','Numero','Telefone','Chamado','Destino','Prioridade','Atendente','Motorista','Observacoes'];
  const rows = [header.join(',')];
  keys.forEach(k=>{
    const r = chamadosLocal[k];
    const line = [r.Data,r.Hora,r.Paciente,r.Endereco,r.Numero,r.Telefone,r.Chamado,r.Destino,r.Prioridade,r.Atendente,r.Motorista,r.Observacoes]
      .map(cell => `"${(cell||'').toString().replace(/"/g,'""')}"`).join(',');
    rows.push(line);
  });
  const csv = rows.join('\n');
  const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `chamados_guai_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};

/* ---------- relatorio mensal ---------- */
$('btnRelatorio').onclick = ()=>{
  const hoje = new Date(); const mes = hoje.getMonth(); const ano = hoje.getFullYear();
  const keys = Object.keys(chamadosLocal || {});
  const chamadosMes = keys.map(k=>chamadosLocal[k]).filter(c=> {
    if(!c || !c.Data) return false;
    const parts = c.Data.split('/'); if(parts.length<3) return false;
    const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return d.getMonth()===mes && d.getFullYear()===ano;
  });
  const tipos = {Normal:0, Urg√™ncia:0, Emerg√™ncia:0};
  const prioridades = {}; const destinos = {};
  chamadosMes.forEach(c=>{
    const t = (c.Chamado||'').toLowerCase();
    if(t.includes('urg')) tipos['Urg√™ncia']++;
    else if(t.includes('emerg')) tipos['Emerg√™ncia']++;
    else tipos['Normal']++;
    prioridades[c.Prioridade||'N√£o definida'] = (prioridades[c.Prioridade]||0)+1;
    destinos[c.Destino||'N√£o definido'] = (destinos[c.Destino]||0)+1;
  });
  let csv = `Relat√≥rio mensal - ${hoje.toLocaleDateString('pt-BR')}\n\nTipo,Quantidade\n`;
  Object.keys(tipos).forEach(k=> csv += `${k},${tipos[k]}\n`);
  csv += '\nPrioridade,Quantidade\n'; Object.keys(prioridades).forEach(k=> csv += `${k},${prioridades[k]}\n`);
  csv += '\nDestino,Quantidade\n'; Object.keys(destinos).forEach(k=> csv += `${k},${destinos[k]}\n`);
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=`relatorio_mensal_${new Date().toISOString().slice(0,10)}.csv`; a.click();
};

/* ---------- grafico ---------- */
function atualizarGrafico(){
  const ctx = document.getElementById('graficoMensal').getContext('2d');
  const counts = {Normal:0, Urg√™ncia:0, Emerg√™ncia:0};
  Object.values(chamadosLocal || {}).forEach(c=>{
    const k = (c.Chamado||'').toLowerCase();
    if(k.includes('urg')) counts['Urg√™ncia']++;
    else if(k.includes('emerg')) counts['Emerg√™ncia']++;
    else counts['Normal']++;
  });
  const labels = Object.keys(counts), data = Object.values(counts);
  if(chart) chart.destroy();
  chart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Chamados (m√™s)', data, backgroundColor:['#2ecc71','#f1c40f','#c92b2b'] }] }, options:{responsive:true,plugins:{legend:{display:false}} }});
}

/* ---------- search ---------- */
$('search').addEventListener('input', (e)=> renderTabelaFromFirebase(e.target.value));

/* ---------- chat (real-time) ---------- */
function appendChatMessage(m){
  const list = $('chatList');
  const row = document.createElement('div');
  const time = new Date(m.time || Date.now()).toLocaleTimeString();
  row.innerHTML = `<div style="font-size:13px"><strong>${m.userName||'Usu√°rio'}</strong> <span style="color:#777;font-size:12px">(${time})</span></div><div style="font-size:14px">${m.text}</div><hr style="margin:6px 0">`;
  list.appendChild(row); list.scrollTop = list.scrollHeight;
}
$('chatSend').onclick = ()=> {
  const text = $('chatInput').value.trim(); if(!text) return;
  const userName = $('atendente').value.trim() || 'Usu√°rio';
  chatRef.push({ text, userName, uid: currentUID, time: Date.now() });
  $('chatInput').value = '';
};
$('chatInput').addEventListener('keypress', (e)=> { if(e.key==='Enter'){ e.preventDefault(); $('chatSend').click(); } });

/* ---------- import CSV once into Firebase (only-if not imported before) ---------- */
async function importCSVOnceToFirebase(){
  try{
    if(localStorage.getItem('csv_imported')) return; // already imported
    // fetch CSV using allorigins to avoid CORS
    const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(CSV_URL));
    if(!res.ok) throw new Error('status '+res.status);
    const j = await res.json();
    const parsed = parseCSV(j.contents || '');
    if(!parsed.length) { localStorage.setItem('csv_imported','1'); return; }
    const updates = {};
    parsed.forEach(row=>{
      const key = chamadosRef.push().key;
      updates[key] = {
        Data: row['Data']||row['data']||'',
        Hora: row['Hora']||row['hora']||'',
        Paciente: row['Paciente']||row['Nome']||'',
        Endereco: row['Endere√ßo']||row['Endereco']||row['logradouro']||'',
        Numero: row['N√∫mero']||row['Numero']||'',
        Telefone: row['Telefone']||'',
        Chamado: (row['Chamado']||row['Tipo']||'normal').toLowerCase(),
        Destino: row['Destino']||'',
        Prioridade: row['Prioridade']||'',
        Atendente: row['Atendente']||'',
        Motorista: row['Motorista']||'',
        Observacoes: row['Observa√ß√µes']||row['Obs']||'',
        createdBy: currentUID || (row['Atendente']||''),
        createdAt: Date.now()
      };
    });
    await chamadosRef.update(updates);
    localStorage.setItem('csv_imported','1');
    console.log('CSV importado para Firebase (uma vez).');
  }catch(err){
    console.warn('Import CSV falhou:', err);
  }
}

/* ---------- add-option buttons ---------- */
$('btnAddEndereco').onclick = ()=> { const v = prompt('Digite novo endere√ßo:'); if(!v) return; enderecoLista.push(v); populateSelects(); localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista})); };
$('btnAddEnderecoManual').onclick = ()=> { const v = prompt('Digite novo endere√ßo:'); if(!v) return; enderecoLista.push(v); populateSelects(); localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista})); };
$('btnAddPrioridade').onclick = ()=> { const v = prompt('Digite nova prioridade:'); if(!v) return; prioridadeLista.push(v); populateSelects(); localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista})); };
$('btnAddDestino').onclick = ()=> { const v = prompt('Digite novo destino:'); if(!v) return; destinoLista.push(v); populateSelects(); localStorage.setItem('app_options', JSON.stringify({enderecoLista, prioridadeLista, destinoLista})); };

/* ---------- logo base64 import/reset ---------- */
$('btnImportBase64').onclick = async ()=> {
  const paste = prompt('Cole data:image/... base64 (ou URL p√∫blica). Se colar URL e der CORS, converta para base64 e cole.');
  if(!paste) return;
  if(paste.startsWith('data:')){ localStorage.setItem('logo_base64', paste); $('logoImg').src = paste; alert('Imagem salva em base64.'); return; }
  // try convert
  try{
    const res = await fetch(paste);
    const blob = await res.blob();
    const reader = new FileReader();
    reader.onloadend = ()=>{ localStorage.setItem('logo_base64', reader.result); $('logoImg').src = reader.result; alert('Imagem convertida e salva.'); };
    reader.readAsDataURL(blob);
  }catch(e){ alert('Falha ao buscar/convertir imagem (prov√°vel CORS). Cole base64 direto.'); }
};
$('btnResetLogo').onclick = ()=> { localStorage.removeItem('logo_base64'); $('logoImg').src = 'https://drive.google.com/uc?export=view&id=1ISJU9dEUo14fePstTcknKWKhsf_hixgB'; alert('Imagem resetada.'); };

/* ---------- load saved app options ---------- */
function loadAppOptions(){
  try{
    const s = localStorage.getItem('app_options'); if(!s) return;
    const o = JSON.parse(s); if(o.enderecoLista) enderecoLista = Array.from(new Set([...enderecoLista, ...o.enderecoLista])); if(o.prioridadeLista) prioridadeLista = Array.from(new Set([...prioridadeLista, ...o.prioridadeLista])); if(o.destinoLista) destinoLista = Array.from(new Set([...destinoLista, ...o.destinoLista])); 
  }catch(e){ console.warn(e); }
}

/* ---------- init ---------- */
async function init(){
  loadAppOptions();
  const base = localStorage.getItem('logo_base64'); if(base) $('logoImg').src = base;
  populateSelects();
  // try import csv once (if not imported)
  await importCSVOnceToFirebase();
  // initial render (data will come in from firebase listener)
  // restore atendente name if saved
  const savedAt = localStorage.getItem('atendente_name');
  if(savedAt) $('atendente').value = savedAt;
  // listen atendente change to save locally
  $('atendente').addEventListener('change', ()=> localStorage.setItem('atendente_name', $('atendente').value.trim()));
}
init();
</script>
</body>
</html>
