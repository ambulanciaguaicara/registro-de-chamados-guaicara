<!doctype html>
<html lang='pt-BR'>
<head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Registro de Chamados de ambul√¢ncia - Guaicara</title>
<style>
:root{:--samu:#b71c1c;--bg:#fbfbfb;--card:#fff;--muted:#6b7280}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#0b1220}
.header{background:linear-gradient(90deg,var(--samu),#910000);color:#fff;padding:14px 18px}
.container{max-width:1200px;margin:18px auto;padding:12px}
.panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(2,6,23,0.06);margin-bottom:12px}
.button{background:var(--samu);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.button.ghost{background:transparent;color:var(--samu);border:1px solid rgba(183,28,28,0.12);padding:8px 10px;border-radius:8px}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #f1f1f1;text-align:left}
th{background:rgba(183,28,28,0.06);color:var(--samu)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
.chat-messages{flex:1;padding:8px;overflow:auto;background:linear-gradient(180deg,#fbfdff,#fff)}
.input-small{padding:6px;border-radius:6px;border:1px solid #e6eefc;width:100%}
.small{font-size:13px;color:var(--muted)}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style></head><body>
<div class='header'><div class='container'><h1>Registro de Chamados de ambul√¢ncia ‚Äì Guaicara/SP</h1><div class='small'>Tema SAMU ‚Äî vermelho escuro ‚Ä¢ Salvar automaticamente na planilha</div></div></div>
<div class='container'>
<div class='panel' style='display:flex;gap:8px;align-items:center;'>
<input id='searchInput' class='input-small' placeholder='üîé Buscar paciente...' style='width:48%' oninput='doSearch()'/>
<button class='button' onclick='addRow()'>‚ûï Novo chamado</button>
<button class='button ghost' onclick='exportCSV()'>üì§ Exportar CSV</button>
<button class='button ghost' onclick='downloadHTML()'>‚¨áÔ∏è Baixar HTML</button>
<div style='margin-left:auto' class='small'>Site: <strong>Registro de Chamados de ambul√¢ncia</strong></div>
</div>
<div class='grid'>
<main class='panel'>
<div style='margin-bottom:8px;display:flex;gap:8px;align-items:center;'>
<label style='display:flex;gap:8px;align-items:center;'><strong>Importar CSV:</strong> <input id='importFile' type='file' accept='.csv' onchange='importCSV(event)'></label>
<button class='button ghost' onclick='pasteJsonPrompt()'>Colar JSON</button>
</div>
<div class='table-wrap' style='max-height:520px;overflow:auto;'>
<table id='chamadosTable'><thead><tr><th>Sel</th><th>Data</th><th>Hora</th><th>Paciente</th><th>Endere√ßo</th><th>Telefone</th><th>Tipo</th><th>Destino</th><th>Prioridade</th><th>Atendente</th><th>Motorista</th><th>Observa√ß√µes</th><th>Replicar</th></tr></thead><tbody></tbody></table>
</div>
<div id='relatorios' class='panel'><h3>üìä Relat√≥rio Mensal</h3><div id='relatorioConteudo' class='small'>Nenhum dado dispon√≠vel.</div><canvas id='graficoChamados' style='max-width:720px;margin-top:8px'></canvas></div>
</main>
<aside style='display:flex;flex-direction:column;gap:12px'>
<div class='panel'><h4>Usu√°rio</h4><div style='display:flex;gap:8px;align-items:center'><span id='usernameDisplay' class='small'></span><button class='button ghost' onclick='promptUser()'>Trocar nome</button></div><div class='small' style='margin-top:6px'>Nome obrigat√≥rio para postar no chat.</div></div>
<div class='panel chat'><div style='padding:8px;border-bottom:1px solid #eef2ff'><strong>Chat interno</strong> <span class='small'> (salvo na aba "Chat")</span></div><div class='chat-messages' id='chatMessages'></div><div style='display:flex;gap:8px;padding:8px;border-top:1px solid #eef2ff;background:#fff'><input id='chatInput' placeholder='Escreva uma mensagem...' onkeydown="if(event.key==='Enter') sendChat()" style='flex:1;padding:8px;border-radius:6px;border:1px solid #e6eefc'/><button class='button' onclick='sendChat()'>Enviar</button><button class='button ghost' onclick='exportChat()'>Exportar Chat</button></div></div>
<div class='panel small'><strong>Ajuda r√°pida</strong><ul><li>Use a busca para localizar um paciente rapidamente</li><li>Adicione destinos/prioridades com o bot√£o ‚ûï</li><li>Para sincronizar com a planilha: Conectar ‚Üí Carregar ‚Üí Salvar</li></ul></div>
</aside></div>
<div class='footer small'>Desenvolvido para Prefeitura Municipal de Guaicara ‚Ä¢ Vers√£o pronta para Vercel</div></div>
<script src='https://apis.google.com/js/api.js'></script>
<script src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'></script>
<script>
const CLIENT_ID = '864225953887-s8vg683v8t3lesrsdmcd5rd77hmafl5f.apps.googleusercontent.com';
const API_KEY = '';
const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
const spreadsheetId = '1M9ZTOHGIvcZcqLw5i6Z6ZVhe3RS73qCnxDeVYuy_SbQ';
const SHEET_NAME = 'Sheet1';
const CHAT_SHEET_NAME = 'Chat';

let destinosList = JSON.parse(localStorage.getItem('destinosList')||'null') || ["CSIII","COHAB","DOM BOSCO","VILA SA√öDE","HGP","Santa Casa","AME","HEMODI√ÅLISE","CTA","HAPVIDA","UNIMED","FISIOTERAPIA","CAPS","AGAR-Gestante alto risco","CANJARANA","TARAMA","N√ÅUTICA BRANDA","IML"];
let prioridadesList = JSON.parse(localStorage.getItem('prioridadesList')||'null') || ["Nenhuma","Curativo","Doen√ßas cr√¥nicas ou complica√ß√µes","AUTISTA","DEFICI√äNTE","FIBROMIALGIA","GESTANTE","IDOSO","ACAMADO","MOBILIDADE REDUZIDA","PEDIATRA","ACIDENTE"];
let chart = null;

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function initGapi(){ gapi.load('client:auth2', async ()=>{ try{ await gapi.client.init({ apiKey:API_KEY||undefined, clientId:CLIENT_ID, discoveryDocs:DISCOVERY_DOCS, scope:SCOPES }); gapi.auth2.getAuthInstance().isSignedIn.listen(()=>{}); document.getElementById('usernameDisplay').textContent = localStorage.getItem('chat_username') || ''; }catch(e){ console.error(e); } }); }

function addRow(){ const tbody=document.querySelector('#chamadosTable tbody'); const row=tbody.insertRow(); row.innerHTML = `<td><input type="checkbox" class="sel"></td><td><input value=""></td><td><input value=""></td><td><input value=""></td><td><input value=""></td><td><input value=""></td><td><select><option>Normal</option><option>Urg√™ncia</option><option>Emerg√™ncia</option></select></td><td><select>${destinosList.map(x=>`<option>${escapeHtml(x)}</option>`).join('')}</select></td><td><select>${prioridadesList.map(x=>`<option>${escapeHtml(x)}</option>`).join('')}</select></td><td><input value=""></td><td><input value=""></td><td><textarea></textarea></td><td><button onclick="replicar(this)">üîÅ</button></td>`; row.querySelectorAll('input,select,textarea').forEach(el=>el.addEventListener('input',()=>{ saveLocal(); updateReport(); })); updateReport(); }



function addRowFromData(d){ const tbody=document.querySelector('#chamadosTable tbody'); const row=tbody.insertRow(); row.innerHTML = `<td><input type="checkbox" class="sel"></td><td><input value="${escapeHtml(d.data||'')}"></td><td><input value="${escapeHtml(d.hora||'')}"></td><td><input value="${escapeHtml(d.paciente||'')}"></td><td><input value="${escapeHtml(d.endereco||'')}"></td><td><input value="${escapeHtml(d.telefone||'')}"></td><td><select><option ${d.tipo==='Normal'?'selected':''}>Normal</option><option ${d.tipo==='Urg√™ncia'?'selected':''}>Urg√™ncia</option><option ${d.tipo==='Emerg√™ncia'?'selected':''}>Emerg√™ncia</option></select></td><td><select>${destinosList.map(x=>`<option ${x===d.destino?'selected':''}>${escapeHtml(x)}</option>`).join('')}</select></td><td><select>${prioridadesList.map(x=>`<option ${x===d.prioridade?'selected':''}>${escapeHtml(x)}</option>`).join('')}</select></td><td><input value="${escapeHtml(d.atendente||'')}"></td><td><input value="${escapeHtml(d.motorista||'')}"></td><td><textarea>${escapeHtml(d.observacoes||'')}</textarea></td><td><button onclick="replicar(this)">üîÅ</button></td>`; row.querySelectorAll('input,select,textarea').forEach(el=>el.addEventListener('input',()=>{ saveLocal(); updateReport(); })); }
